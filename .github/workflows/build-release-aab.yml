name: Build Release AAB

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        lfs: true

    - name: Pull LFS files
      run: |
        git lfs pull
        echo "Checking LFS files..."
        du -sh app/src/main/assets/reference_images/
        du -sh app/src/main/assets/embeddings_mobilenetv3.json.gz

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Create keystore
      run: |
        echo '${{ secrets.KEYSTORE_BASE64 }}' > keystore.b64
        base64 -d keystore.b64 > diecast-release.keystore
        rm keystore.b64

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Build Release AAB
      run: |
        ./gradlew bundleRelease --no-daemon

    - name: Verify AAB
      run: |
        AAB_PATH="app/build/outputs/bundle/release/app-release.aab"
        if [ -f "$AAB_PATH" ]; then
          echo "‚úÖ AAB generated successfully"
          ls -lh "$AAB_PATH"

          # Extract and verify versionCode
          unzip -q "$AAB_PATH" -d aab_extracted
          VERSION_CODE=$(grep -oP 'android:versionCode="\K[0-9]+' aab_extracted/base/manifest/AndroidManifest.xml || echo "unknown")
          VERSION_NAME=$(grep -oP 'android:versionName="\K[^"]+' aab_extracted/base/manifest/AndroidManifest.xml || echo "unknown")
          echo "üì± Version Code: $VERSION_CODE"
          echo "üì± Version Name: $VERSION_NAME"

          if [ "$VERSION_CODE" != "8" ]; then
            echo "‚ùå ERROR: Expected versionCode 8, but got $VERSION_CODE"
            exit 1
          fi
        else
          echo "‚ùå AAB not found"
          exit 1
        fi

    - name: Upload AAB
      uses: actions/upload-artifact@v4
      with:
        name: car-identifier-release-aab-v2.0.2-versionCode8
        path: app/build/outputs/bundle/release/app-release.aab
        retention-days: 30
